name: Uniffi XForge (macOS)

on:
  workflow_dispatch:
    inputs:
      publish:
        description: "Publish release assets (requires secrets)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  bundle:
    runs-on: macos-latest
    permissions:
      contents: write
    env:
      CARGO_TARGET_DIR: ${{ github.workspace }}/target
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Add target
        run: rustup target add aarch64-apple-darwin
      - name: Build library (macOS)
        run: |
          echo "CARGO_TARGET_DIR=$CARGO_TARGET_DIR"
          cargo run -p libforge-cli -- build \
            --manifest-dir examples/uniffi-xforge \
            --target aarch64-apple-darwin \
            --profile release
      - name: Cargo build (macOS)
        run: |
          cargo build --release \
            --manifest-path examples/uniffi-xforge/Cargo.toml \
            --target aarch64-apple-darwin
      - name: Verify build output
        run: |
          ls -la target || true
          ls -la target/release || true
          ls -la target/aarch64-apple-darwin/release || true
          find target -maxdepth 5 -name "libuniffi_xforge.dylib" -print || true
      - name: Bundle artifacts (macOS)
        run: |
          cargo run -p libforge-cli -- bundle \
            --manifest-dir examples/uniffi-xforge \
            --target aarch64-apple-darwin \
            --output-dir examples/uniffi-xforge/dist \
            --profile release
      - name: Publish release
        if: ${{ inputs.publish == 'true' }}
        env:
          LIBFORGE_PRIVATE_KEY: ${{ secrets.LIBFORGE_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cargo run -p libforge-cli -- publish \
            --manifest examples/uniffi-xforge/dist/libforge-manifest.json \
            --assets-dir examples/uniffi-xforge/dist
